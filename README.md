# Global-illumination-using-photon-map

## 介绍

光线追踪在图像分析中是其中一种最受欢迎和最有力的技术：简单，高效，容易实现。但是，有一些情况光线追踪不能处理。比如说diffuse inter-reflection（color bleeding）,caustics(游泳池底部闪闪发光的水波).这两种情况都属于diffuse表面的非直接光照。本文介绍两种基于photon map的全局光照算法caustic photon map 和 global photon map。第一阶段，两种photon map 在从光源发出的光子在碰到diffuse表面的时候，会被创建来存储发射的光子。第二阶段，也就是渲染阶段，使用统计技术在photon map上面来提取场景中任一点的入射光通量和反射光的信息。

## 光子追踪

光子追踪的目的是为了计算diffuse表面的非直接光照。首先从光源发射光子，然后跟踪他们穿过场景，最后存储在diffuse表面上。

### 光子发射

光子可以从单光源发射也可以从多光源发射。使用photon map可以提高光源发射效率。

#### 从单光源发射光子

单光源有几种：
1. 点光源
从点光源发射出的光子是从一个点发射出的任意方向的光子。
1. 平行光源
光子从平行光源发出的光具有相同的方向，但是是从场景外面发射出来的
1. diffuse square light
在立方体中的任意一点发出，方向局限于一个半球。从立方体中发出的光子方向相同的可能性为0，方向正交的可能性很大。
1. general light
比如灯泡，光子可能在任意位置任意方向射出。

#### 从多光源发射光子

如果场景中包含多个光源，光子应该从每个光源中射出。更亮的光源发出的光子会更多一些，这样可以使发射的光子的能量大致相同。光源多发出的光子不一定多。在多光源的场景中，每个光源贡献的光亮度会更少一些，每个光源发射的光子也就更少一些。


#### projection maps

一个场景中如果几何体很少的话，很多光子不会撞击到任何物体。发射这些光子就相当于浪费时间。为了优化这个过程，使用projection map。这个map由很多小的单元组成。如果这个单元是"on"的状态，那说明在这个方向有几何体。如果是"off"，说明这个方向没有物体。对于一个点光源来说，projection map是一个球形的。对于一个平行光源来说，projection  map是一个平面。为了简化映射，我们可以在场景的每个物体或每一堆物体都设计一个包围球。这样可以提高效率。关于projection map最重要的一个方面是它给了大致的需要发射光子的方向。

使用photon map发射光子非常简单。我们可以遍历photon map中的每个单元，如果是on的状态，我们就在这个单元的方向发射一个任意的光子。但是，可能还没有遍历完这些单元，photon map就已经满了。还有一种方式是我们可以生成任意方向来判断这个方向对应的单元中是否含有物体。


### 光子追踪
 
光子追踪和光线追踪的原理是一样的，除了一点，光子是传播光通量（flux）而光线聚集光亮度(radiance).所以光子和材质的交互和光线和材质的交互是不一样的。一个例子就是当光线折射的时候会根据相关系数来决定折射后的光线，但是光子不会这样。

当光子撞击到一个物体的时候，可能会被反射（reflection），继续传播(transmission)或者被吸收(absorption)。是否发生反射，继续传播或者吸收取决于表面的材料。这是由俄罗斯轮盘决定的。


#### Reflection,transmission,or absorption?

对于一个反射表面diffuse的反射系数为d,specular 反射系数为s(d+s<=1).使用一个随机变量ξ∈[0,1],

![]()
举个例子，使用俄罗斯轮盘我们不需要改变反射光子的能量。例如，一个表面可以反射50个入射光，使用俄罗斯轮盘的话，只有一半的入射光会被反射（with full energy）。如果你往表面发射1000个光子，你可以反射1000个相比原来有一半能量的光子，也可以发射500个满能量的光子。这样可以大大减少计算量。

使用RGB颜色值的话，会稍微有点复杂。因为三个color band有不同的反射系数。specular和diffuse反射是基于每种颜色的反射或者是任意颜色的最大能量反射。如果是基于某种颜色的最大能量，反射的可能性可以如下计算：
![]()

那么diffuse反射的可能性为：
![]()
镜面反射的可能性为:
![]()

那么，决定是反射还是吸收的公式变成如下：
![]()

反射光子的能量如下计算：（镜面反射）
![]()
Pinc是入射光子的能量。

我们又计算了一下可能性是因为我们不会浪费时间发射低能量的光子。

#### 为什么使用俄罗斯轮盘呢？

我们为什么要做这些努力来决定光子的行为呢？为什么不直接跟踪diffuse和specular反射之后新的方向的光子，然后根据参数来该表光子的能量呢？两个原因。1、我们希望光子图中的光子有相似大小的能量。这样使用少量的光子就可以使光估计更好一些。2、如果每个表面有两个光子交互，8次交互之后，我们就会得到2的8次方个光子，这样并不好。我们想经过5-8次反弹的光子数和经过1-2次反弹的光子数一样少。所以使用俄罗斯转盘就很有必要。

使用俄罗斯转盘有一个警告。它增加了解决方案的变数。它不是使用确切的数值来决定是反射还是传播来改变光子的能量，我们依赖对这些数值的采样，可以收敛到和足够多光子使用的时候的结果。

